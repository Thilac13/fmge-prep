<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- iOS Standalone Web App Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FMGE Prep">
    <meta name="theme-color" content="#0F2027">
    
    <title>FMGE Revision</title>
    <style>
        :root {
            --bg-grad-start: #0F2027;
            --bg-grad-mid: #203A43;
            --bg-grad-end: #2C5364;
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text: #ffffff;
            --accent: #4CA1AF;
            --success: #00b09b;
            --error: #e74c3c;
            --font-main: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --nav-height: 80px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background: linear-gradient(135deg, var(--bg-grad-start), var(--bg-grad-mid), var(--bg-grad-end));
            color: var(--text);
            font-family: var(--font-main);
            margin: 0; padding: 0;
            width: 100vw;
            height: 100dvh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- Views Container --- */
        #main-view {
            flex: 1;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .tab-content {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: none;
            flex-direction: column;
            padding-top: env(safe-area-inset-top);
        }
        .tab-content.active { display: flex; }

        /* --- Header --- */
        header {
            height: 60px;
            flex-shrink: 0;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px;
            background: rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            z-index: 100;
        }
        .header-title { font-weight: 700; font-size: 18px; }

        /* --- CARD VIEW --- */
        #stack-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow: hidden;
            position: relative;
        }

        .card {
            width: 100%; max-width: 380px;
            height: auto;
            max-height: 60vh; 
            aspect-ratio: 3/4.5;
            
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            
            display: flex; flex-direction: column;
            padding: 24px;
            
            position: relative; 
            transform: scale(1);
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .question {
            font-size: 19px; font-weight: 700; line-height: 1.4;
            margin-bottom: 20px; flex-shrink: 0;
        }
        .options { display: flex; flex-direction: column; gap: 10px; overflow-y: auto; flex-grow: 1;}
        
        .btn {
            padding: 16px; background: rgba(255,255,255,0.07);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 16px; color: rgba(255,255,255,0.9);
            text-align: left; font-size: 16px; font-weight: 500;
            cursor: pointer; transition: 0.2s;
        }
        .btn.correct { background: var(--success) !important; color: #fff; border: none; opacity: 1 !important; }
        .btn.wrong { background: var(--error) !important; color: #fff; border: none; opacity: 1 !important; }

        /* Animation Classes */
        .slide-out-left { transform: translateX(-120%) rotate(-15deg) !important; opacity: 0 !important; }
        .slide-out-right { transform: translateX(120%) rotate(15deg) !important; opacity: 0 !important; }
        .fade-in { animation: fadeIn 0.4s ease backwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        /* --- CONTROLS --- */
        #controls {
            height: 90px;
            flex-shrink: 0;
            display: flex; justify-content: center; gap: 20px; align-items: center;
            padding-bottom: 10px;
            z-index: 101;
        }
        .ctrl-btn {
            background: rgba(255,255,255,0.1); border: none; color: #fff;
            width: 140px; padding: 14px 0; border-radius: 30px;
            font-size: 15px; font-weight: 600; backdrop-filter: blur(5px);
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .btn-master { background: rgba(48, 209, 88, 0.2); color: #30d158; border: 1px solid rgba(48, 209, 88, 0.3); }

        /* --- BROWSE & LISTS --- */
        .scroll-area { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; }
        .search-bar {
            width: 100%; padding: 12px; background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; 
            color: white; font-size: 16px; margin-bottom: 20px;
        }
        .subject-group { margin-bottom: 20px; }
        .subject-header { font-size: 14px; font-weight: 700; color: var(--accent); text-transform: uppercase; margin-bottom: 10px; }
        
        .q-list-item {
            background: var(--glass-bg); border-bottom: 1px solid rgba(255,255,255,0.05);
            padding: 15px; display: flex; align-items: center; justify-content: space-between; font-size: 14px;
        }
        .q-list-item:first-child { border-top-left-radius: 12px; border-top-right-radius: 12px; }
        .q-list-item:last-child { border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; border-bottom: none; }
        
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #555; flex-shrink: 0; }
        .status-dot.mastered { background: var(--success); }

        /* --- BOTTOM NAV --- */
        .bottom-nav {
            height: var(--nav-height);
            background: rgba(15, 32, 39, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-around; align-items: center;
            padding-bottom: env(safe-area-inset-bottom);
            flex-shrink: 0;
            z-index: 200;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            color: rgba(255,255,255,0.5); font-size: 10px; font-weight: 600;
            padding: 10px; transition: 0.2s;
        }
        .nav-item.active { color: var(--accent); transform: scale(1.1); }
        .nav-icon { font-size: 20px; margin-bottom: 4px; }

        /* --- Modal --- */
        #modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 300;
            display: none; align-items: center; justify-content: center;
            padding: 20px;
        }
        #modal-overlay.open { display: flex; }

        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 500; }
    </style>
</head>
<body>

<canvas id="confetti-canvas"></canvas>

<!-- TAB 1: CARDS -->
<div id="tab-cards" class="tab-content active">
    <header>
        <div class="header-title">Cards</div>
        <div id="queue-count" style="font-size: 12px; opacity: 0.7;">0 Left</div>
    </header>
    
    <div id="stack-container">
        <!-- Cards Injected via JS -->
    </div>
    
    <div id="controls">
        <button class="ctrl-btn" onclick="triggerNext('skip')">Skip</button>
        <button class="ctrl-btn btn-master" onclick="triggerNext('master')">Mastered</button>
    </div>
</div>

<!-- TAB 2: BROWSE -->
<div id="tab-browse" class="tab-content">
    <header><div class="header-title">Browse Topics</div></header>
    <div class="scroll-area">
        <input type="text" class="search-bar" placeholder="Search questions..." onkeyup="filterBrowse(this.value)">
        <div id="browse-list"></div>
    </div>
</div>

<!-- TAB 3: PROFILE -->
<div id="tab-profile" class="tab-content">
    <header><div class="header-title">My Progress</div></header>
    <div class="scroll-area">
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <div style="flex:1; background:var(--success); padding:20px; border-radius:16px; text-align:center; color:#000;">
                <div style="font-size:32px; font-weight:800;" id="stat-mastered">0</div>
                <div style="font-size:12px; font-weight:600;">MASTERED</div>
            </div>
            <div style="flex:1; background:#333; padding:20px; border-radius:16px; text-align:center;">
                <div style="font-size:32px; font-weight:800;" id="stat-left">0</div>
                <div style="font-size:12px; font-weight:600; opacity:0.7;">LEFT</div>
            </div>
        </div>
        
        <h3 style="margin-bottom:10px; margin-top:0;">Mastered Questions</h3>
        <div id="mastered-list" style="margin-bottom:30px;">
            <!-- Mastered List Injected Here -->
        </div>

        <button onclick="resetAll()" style="width:100%; padding:15px; background:var(--error); border:none; border-radius:12px; color:white;">Reset Progress</button>
    </div>
</div>

<!-- NAV -->
<div class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('cards')">
        <div class="nav-icon">üÉè</div><div>Cards</div>
    </div>
    <div class="nav-item" onclick="switchTab('browse')">
        <div class="nav-icon">üìö</div><div>Browse</div>
    </div>
    <div class="nav-item" onclick="switchTab('profile')">
        <div class="nav-icon">üìä</div><div>Profile</div>
    </div>
</div>

<!-- MODAL -->
<div id="modal-overlay" onclick="closeModal(event)"></div>

<script>
const raw_data = `ST-elevation in leads II, III, and aVF. Which artery is occluded?|LAD|LCx|Right Coronary Artery (RCA)|Left Main|C
Tall tented T-waves, K+ 7.2. First step?|Insulin + Dextrose|IV Calcium Gluconate|Salbutamol|Dialysis|B
TB patient on ATT, tingling/numbness. Deficiency of?|Vit B1|Vit B3|Vit B6 (Pyridoxine)|Vit B12|C
Max time window for IV Thrombolysis in stroke?|3 hours|4.5 hours|6 hours|12 hours|B
Fruity breath, Kussmaul breathing, Sugar 450. Diagnosis?|HHS|Diabetic Ketoacidosis (DKA)|Lactic Acidosis|Hypoglycemia|B
Murmur best heard in left lateral decubitus with bell?|Aortic Stenosis|Mitral Stenosis|Mitral Regurgitation|Pulmonary Stenosis|B
Cannon a-waves in JVP. Sign of?|AFib|Complete Heart Block (3rd Degree)|Tamponade|TR|B
DOC for hyperthyroidism in 1st trimester pregnancy?|Methimazole|Propylthiouracil (PTU)|Carbimazole|Radioactive Iodine|B
Triad of Wernicke's: Confusion, Ataxia, and?|Ophthalmoplegia|Seizures|Diarrhea|Dermatitis|A
Male, morning back pain improves with exercise, HLA-B27+. Diagnosis?|RA|OA|Ankylosing Spondylitis|Psoriatic Arthritis|C
Hallmark finding in Nephrotic Syndrome?|Hematuria|Proteinuria (>3.5g/day)|Hypertension|Oliguria|B
Thunderclap headache investigation of choice?|MRI|NCCT Head|LP|EEG|B
C-ANCA positivity is associated with?|Wegener's (GPA)|Churg-Strauss|Microscopic Polyangiitis|SLE|A
Most common cause of Community-Acquired Pneumonia?|Strep pneumoniae|Mycoplasma|Staph aureus|Klebsiella|A
Currant Jelly Sputum is seen in?|Pneumococcus|Klebsiella pneumoniae|Pseudomonas|Mycoplasma|B
Anti-tubercular drug causing Red-Green color blindness?|Isoniazid|Rifampicin|Ethambutol|Pyrazinamide|C
Immediate management of Tension Pneumothorax?|Needle Decompression|Wait for CXR|Antibiotics|Intubation|A
DOC for absence seizures in a child?|Phenytoin|Carbamazepine|Ethosuximide|Gabapentin|C
Tram-track appearance on CT Head seen in?|Sturge-Weber Syndrome|Tuberous Sclerosis|Neurofibromatosis|VHL|A
Beck's Triad: Hypotension, Muffled Sounds, and?|Raised JVP|Bradycardia|Pulm Edema|Wheeze|A
Scoring system for Acute Pancreatitis severity?|Ranson's Criteria|Child-Pugh|Gleason|Wells|A
Drug of choice for MRSA?|Amoxicillin|Ceftriaxone|Vancomycin|Azithromycin|C
Which Hepatitis virus is DNA based?|Hep A|Hep B|Hep C|Hep E|B
Rice water stools are characteristic of?|Typhoid|Cholera|Shigellosis|Amoebiasis|B
Antidote for Paracetamol poisoning?|Atropine|N-Acetylcysteine (NAC)|Flumazenil|Naloxone|B
Serum marker for Hepatocellular Carcinoma?|CEA|CA-125|Alpha-Fetoprotein (AFP)|CA 19-9|C
Typical ECG finding in Hypokalemia?|Tall T|U waves|Short QT|Wide QRS|B
Mask-like face and Pill-rolling tremor seen in?|Parkinson's Disease|Alzheimer's|Huntington's|Wilson's|A
MC opportunistic infection in HIV in India?|PCP|Tuberculosis|Candida|Toxo|B
Drug of choice for Scrub Typhus?|Penicillin|Doxycycline|Ceftriaxone|Metronidazole|B
GCS: Eyes open to pain (2), Inappropriate words (3), Localizes pain (5). Total?|10|12|8|9|A
Most common type of Thyroid Carcinoma?|Follicular|Papillary|Medullary|Anaplastic|B
Orphan Annie Eye nuclei are seen in?|Papillary Thyroid Ca|Follicular Ca|Medullary Ca|Hashimoto's|A
Fluid resuscitation formula for burns?|Parkland Formula|Rule of Nines|Holliday-Segar|Brooke|A
Nerve injured in mid-shaft humerus fracture?|Median|Ulnar|Radial Nerve|Axillary|C
Investigation of choice for solitary thyroid nodule?|USG|FNAC|Scan|CT|B
Bird's Beak appearance on Barium Swallow?|Achalasia Cardia|Ca Esophagus|GERD|Zenker's|A
Murphy's Sign is positive in?|Appendicitis|Acute Cholecystitis|Pancreatitis|Renal Colic|B
Most common site for Ca Stomach?|Fundus|Body|Antrum|Cardia|C
Triple Assessment for Breast lump: Clinical, Imaging, and?|MRI|Pathology (FNAC/Biopsy)|Markers|PET|B
Hernia medial to inferior epigastric vessels?|Direct Inguinal|Indirect Inguinal|Femoral|Spigelian|A
Coffee bean sign on X-ray Abdomen?|Sigmoid Volvulus|Cecal Volvulus|Intussusception|Obstruction|A
Management of Tension Pneumothorax is immediate?|CXR|Needle Thoracostomy|CT|Intubation|B
Electrolyte abnormality causing Paralytic Ileus?|Hyperkalemia|Hypokalemia|Hyponatremia|Hypercalcemia|B
MC cause of Appendicitis in children?|Fecalith|Lymphoid Hyperplasia|Worms|Tumor|B
Sausage-shaped mass and Red Currant Jelly stool?|Intussusception|Volvulus|Meckel's|Pyloric Stenosis|A
Courvoisier's Law: Palpable, non-tender GB with jaundice is NOT?|Ca Head Pancreas|Periampullary Ca|Gallstones|Cholangiocarcinoma|C
MC organ injured in blunt abdominal trauma?|Liver|Spleen|Kidney|Intestine|B
Best prognostic factor in Breast Carcinoma?|Size|Axillary Lymph Node Status|Grade|Receptors|B
Sentinel Loop on X-ray is a sign of?|Acute Pancreatitis|Cholecystitis|Appendicitis|Diverticulitis|A
Eburnation of bone is a feature of?|RA|Osteoarthritis|Gout|Septic Arthritis|B
MC bone tumor in children?|Osteosarcoma|Ewing's|Osteochondroma|Chondrosarcoma|A
Onion peel appearance on X-ray?|Osteosarcoma|Ewing's Sarcoma|Osteoclastoma|Multiple Myeloma|B
Trendelenburg test assesses?|Varicose Veins|DVT|PAD|Lymphedema|A
Charcot's Triad (Fever, Jaundice, RUQ Pain) seen in?|Cholecystitis|Ascending Cholangitis|Hepatitis|Pancreatitis|B
Investigation of choice for Renal Stones?|X-ray|USG|NCCT KUB|IVP|C
Wilms' Tumor associated with chromosome deletion?|11p13|13q14|17p|22q|A
MC complication of peptic ulcer disease?|Bleeding|Perforation|Obstruction|Malignancy|A
Treatment for Category III dog bite?|Vaccine only|Vaccine + Immunoglobulin|Observe|Antibiotics|B
GCS minimum and maximum scores?|0-15|3-15|1-10|3-10|B
MC cause of Postpartum Hemorrhage (PPH)?|Atonic Uterus|Trauma|Coagulopathy|Placenta|A
Drug of choice for AMTSL?|Oxytocin|Methergine|Carboprost|Misoprostol|A
Ischial Spines (Station 0) is landmark for?|Engagement|Dilatation|Flexion|Lie|A
Partograph Alert Line starts at cervical dilation of?|3 cm|4 cm|6 cm|10 cm|B
Red Degeneration of Fibroid occurs in?|Hyaline|Pregnancy|Calcific|Cystic|B
Snowstorm appearance on USG?|Vesicular Mole|Ectopic|Abortion|Fibroid|A
Drug of choice for Eclampsia?|Diazepam|Phenytoin|Magnesium Sulfate|Labetalol|C
Earliest sign of MgSO4 toxicity?|Resp Depression|Loss of Knee Jerk|Oliguria|Cardiac Arrest|B
Screening test of choice for Ca Cervix?|Pap Smear|Colposcopy|VIA|Biopsy|A
MC site of Ectopic Pregnancy?|Ampulla|Isthmus|Fimbria|Ovary|A
Pearl Index measures?|Contraceptive Efficacy|Fertility|MMR|PMR|A
Absolute contraindication for OCPs?|History of Thromboembolism|Dysmenorrhea|Acne|PCOD|A
Ideal time for IUCD insertion after delivery?|Within 48h or >6wks|2wks|3wks|4wks|A
Strawberry Cervix is seen in?|Candida|Trichomoniasis|BV|Gonorrhea|B
Whiff test positive in?|Bacterial Vaginosis|Candida|Trichomoniasis|Chlamydia|A
MC cause of secondary amenorrhea?|PCOS|Pregnancy|Thyroid|Prolactinoma|B
Chocolate Cyst seen in?|Endometriosis|Dermoid|PCOD|Serous Cystadenoma|A
Vaccine contraindicated in pregnancy?|Tetanus|Flu|Rubella|Hep B|C
Hormone responsible for ovulation surge?|FSH|LH|Estrogen|Progesterone|B
MC type of ovarian cancer?|Serous Cystadenocarcinoma|Mucinous|Endometrioid|Brenner|A
Curd-like/Cottage cheese discharge seen in?|Candidiasis|Trichomoniasis|BV|Gonorrhea|A
Late deceleration on CTG indicates?|Head compression|Utero-placental insufficiency|Cord compression|Normal|B
Variable deceleration on CTG indicates?|Head compression|Insufficiency|Cord compression|Sleep|C
Bishop's Score is used for?|Inducibility of Labor|Fetal Well-being|Gestational Age|PPH Risk|A
Min number of Antenatal Visits (WHO/GoI)?|4|3|6|8|A
Dose of Anti-D Ig for Rh- mom after Rh+ baby?|100 mcg|300 mcg|500 mcg|50 mcg|B
Maneuver for Shoulder Dystocia?|McRoberts|Ritgen|Leopold|Valsalva|A
MC cause of VVF in developing countries?|Obstructed Labor|Surgery|Radiation|Trauma|A
Twin Peak sign (Lambda) indicates?|Dichorionic Diamniotic|MCDA|MCMA|Conjoined|A
Management of molar pregnancy?|Suction Evacuation|Hysterectomy|Methotrexate|Induction|A
Vaccine stored in freezer (-15 to -25C)?|DPT|Polio (OPV)|Hep B|Pentavalent|B
Most heat-sensitive vaccine?|OPV|BCG|TT|Hep B|A
Most heat-resistant vaccine?|OPV|Measles|Tetanus Toxoid (TT)|DPT|C
Human Anatomical Waste bag color?|Yellow|Red|White|Blue|A
Sharps/Needles container color?|Yellow|Red|White (Puncture Proof)|Blue|C
Plastic waste (IV sets, gloves) bag color?|Yellow|Red|White|Blue|B
Denominator for MMR?|Population|100,000 Live Births|1,000 Live Births|Women 15-49|B
Best indicator of health service effectiveness?|IMR|MMR|CDR|Life Expectancy|A
Vit A prophylaxis dose at 9 months?|100,000 IU|200,000 IU|50,000 IU|10,000 IU|A
Koplik's Spots seen in?|Measles|Chickenpox|Rubella|Mumps|A
Vector for Dengue/Chikungunya?|Aedes aegypti|Anopheles|Culex|Mansonia|A
Vector for Japanese Encephalitis?|Aedes|Anopheles|Culex tritaeniorhynchus|Sandfly|C
Vector for Kala-Azar?|Sandfly|Tsetse|Housefly|Mosquito|A
Step-ladder fever pattern seen in?|Malaria|Typhoid|Dengue|Pneumonia|B
Study design: Effect to Cause?|Cohort|Case-Control|RCT|Cross-sectional|B
Relative Risk (RR) calculated in?|Cohort|Case-Control|Cross-sectional|Ecological|A
Odds Ratio (OR) calculated in?|Cohort|Case-Control|RCT|Ecological|B
Which is a Live vaccine?|BCG|DPT|Hep B|IPV|A
Shake test checks for?|Potency|Frozen damage|Contamination|VVM|B
Vision 2020 goal for blindness prevalence?|1%|0.3%|0.5%|0.1%|B
MC cause of blindness in India?|Refractive Error|Cataract|Glaucoma|Vit A def|B
3 Ds of Pellagra: Dermatitis, Diarrhea, and?|Dementia|Death|Deafness|Dysphagia|A
Pellagra is deficiency of?|Thiamine|Riboflavin|Niacin (B3)|Pyridoxine|C
IDD control program monitors?|Urine Iodine & TSH|Serum Iodine|Thyroid size|Goiter|A
Incubation period of Measles?|10-14 days|2-3 days|20-30 days|1-2 days|A
Herd Immunity not applicable for?|Polio|Measles|Tetanus|Diphtheria|C
JSY promotes?|Institutional Deliveries|Family Planning|Adolescent Health|Nutrition|A
ASHA worker is at which level?|Village (1/1000)|Sub-center|PHC|CHC|A
Quarantine is applied to?|Infected|Healthy contacts|Animals|Vectors|B
Isolation is applied to?|Cases (Infected)|Healthy contacts|Travelers|Immune|A`;

// PARSE DB
let db = [];
const lines = raw_data.split('\n');
lines.forEach((line, idx) => {
    const parts = line.split('|');
    if(parts.length >= 6) {
        let subj = "Unknown";
        if(idx < 30) subj = "Medicine";
        else if(idx < 60) subj = "Surgery";
        else if(idx < 90) subj = "OBG";
        else subj = "PSM";
        
        db.push({
            id: idx,
            q: parts[0],
            options: [parts[1], parts[2], parts[3], parts[4]],
            correct: parts[5].trim().toUpperCase(),
            ansIdx: parts[5].trim().toUpperCase().charCodeAt(0) - 65,
            subject: subj
        });
    }
});

let activeQueue = [];
let mastered = JSON.parse(localStorage.getItem('fmge_mastered_ultimate') || '[]');

function init() {
    activeQueue = db.filter(q => !mastered.includes(q.id));
    activeQueue.sort(() => Math.random() - 0.5);
    renderCard();
    renderBrowse();
    renderProfileList(); // Initial render
    updateStats();
}

// --- CARD RENDERING ---
function renderCard() {
    const stack = document.getElementById('stack-container');
    stack.innerHTML = '';
    
    if(activeQueue.length === 0) {
        stack.innerHTML = `<div style="text-align:center; opacity:0.7"><h3>üéâ All Done!</h3><p>Check Profile</p></div>`;
        document.getElementById('queue-count').innerText = "0 Left";
        return;
    }
    
    document.getElementById('queue-count').innerText = `${activeQueue.length} Left`;
    const q = activeQueue[0];
    
    const card = document.createElement('div');
    card.className = 'card fade-in';
    card.id = 'active-card';
    
    let html = `
        <div class="question">${q.q}</div>
        <div class="options">`;
        
    q.options.forEach((opt, i) => {
        html += `<button class="btn" onclick="checkAnswer(this, ${i}, ${q.ansIdx})">${opt}</button>`;
    });
    html += `</div>`;
    
    card.innerHTML = html;
    stack.appendChild(card);
}

function checkAnswer(btn, selected, correct) {
    const buttons = btn.parentElement.children;
    for(let b of buttons) { 
        b.disabled = true; 
        b.style.opacity = '0.5'; 
        b.style.pointerEvents = 'none';
    }
    btn.style.opacity = '1';
    
    if(selected === correct) {
        btn.classList.add('correct');
    } else {
        btn.classList.add('wrong');
        buttons[correct].classList.add('correct');
        buttons[correct].style.opacity = '1';
    }
}

// --- BUTTON NAVIGATION ---
function triggerNext(action) {
    const card = document.getElementById('active-card');
    if(!card) return;
    
    if(action === 'master') card.classList.add('slide-out-right');
    else card.classList.add('slide-out-left');
    
    setTimeout(() => {
        const q = activeQueue.shift();
        
        if(action === 'master') {
            mastered.push(q.id);
            localStorage.setItem('fmge_mastered_ultimate', JSON.stringify(mastered));
            triggerConfetti();
        } else {
            activeQueue.push(q);
        }
        
        renderCard();
        updateStats();
        renderBrowse();
        renderProfileList(); // Update profile list
    }, 300);
}

// --- BROWSE TAB ---
function renderBrowse() {
    const list = document.getElementById('browse-list');
    list.innerHTML = '';
    
    const subjects = { "Medicine": [], "Surgery": [], "OBG": [], "PSM": [] };
    db.forEach(q => { if(subjects[q.subject]) subjects[q.subject].push(q); });
    
    for(const [subj, qs] of Object.entries(subjects)) {
        const group = document.createElement('div');
        group.className = 'subject-group';
        let html = `<div class="subject-header"><span>${subj}</span><span>${qs.length}</span></div>`;
        
        qs.forEach(q => {
            const isMastered = mastered.includes(q.id);
            html += `
            <div class="q-list-item" onclick="openModal(${q.id})">
                <div style="flex:1; margin-right:10px;">${q.q}</div>
                <div class="status-dot ${isMastered ? 'mastered' : ''}"></div>
            </div>`;
        });
        group.innerHTML = html;
        list.appendChild(group);
    }
}

function filterBrowse(val) {
    const term = val.toLowerCase();
    document.querySelectorAll('.q-list-item').forEach(el => {
        el.style.display = el.innerText.toLowerCase().includes(term) ? 'flex' : 'none';
    });
}

// --- PROFILE TAB (ADDED) ---
function renderProfileList() {
    const list = document.getElementById('mastered-list');
    list.innerHTML = '';
    
    const mList = db.filter(q => mastered.includes(q.id));
    
    if(mList.length === 0) {
        list.innerHTML = '<div style="opacity:0.5; text-align:center; padding:20px; font-size:14px;">No cards mastered yet.</div>';
        return;
    }
    
    // Show most recently mastered at the bottom (or top if reversed)
    // Let's just list them
    mList.forEach(q => {
        list.innerHTML += `
        <div class="q-list-item" onclick="openModal(${q.id})">
            <div style="flex:1; margin-right:10px;">${q.q}</div>
            <div class="status-dot mastered"></div>
        </div>`;
    });
}

// --- MODAL ---
function openModal(id) {
    const q = db.find(x => x.id === id);
    const modal = document.getElementById('modal-overlay');
    
    let html = `
    <div class="card" onclick="event.stopPropagation()">
        <div class="question">${q.q}</div>
        <div class="options">`;
    q.options.forEach((opt, i) => {
        html += `<button class="btn" onclick="checkAnswer(this, ${i}, ${q.ansIdx})">${opt}</button>`;
    });
    html += `</div><div style="margin-top:15px; text-align:center; font-size:12px; opacity:0.5;">Tap outside to close</div></div>`;
    
    modal.innerHTML = html;
    modal.classList.add('open');
}

function closeModal(e) {
    if(e.target.id === 'modal-overlay') e.target.classList.remove('open');
}

// --- STATS ---
function updateStats() {
    document.getElementById('stat-mastered').innerText = mastered.length;
    document.getElementById('stat-left').innerText = db.length - mastered.length;
}

function resetAll() {
    if(confirm("Reset Progress?")) {
        localStorage.removeItem('fmge_mastered_ultimate');
        mastered = [];
        init();
    }
}

// --- TABS ---
function switchTab(tab) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-'+tab).classList.add('active');
    
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    const items = document.querySelectorAll('.nav-item');
    if(tab==='cards') items[0].classList.add('active');
    if(tab==='browse') items[1].classList.add('active');
    if(tab==='profile') {
        items[2].classList.add('active');
        renderProfileList(); // Refresh when opening tab
    }
}

// --- CONFETTI ---
function triggerConfetti() {
    const canvas = document.getElementById('confetti-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    const pieces = [];
    for(let i=0; i<50; i++) pieces.push({
        x: canvas.width/2, y: canvas.height/2, 
        vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10,
        color: `hsl(${Math.random()*360}, 100%, 50%)`, life: 100
    });
    
    function animate() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        let active = false;
        pieces.forEach(p => {
            if(p.life>0) {
                active=true; p.x+=p.vx; p.y+=p.vy; p.life--; 
                ctx.fillStyle=p.color; ctx.fillRect(p.x,p.y,5,5);
            }
        });
        if(active) requestAnimationFrame(animate);
    }
    animate();
}

init();
</script>
</body>
</html>


